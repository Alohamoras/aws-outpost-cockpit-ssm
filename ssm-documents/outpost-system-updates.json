{
  "schemaVersion": "2.2",
  "description": "AWS Outpost system updates and base package installation",
  "parameters": {
    "instanceId": {
      "type": "String",
      "description": "Instance ID for notifications",
      "default": "{{INSTANCE_ID}}"
    }
  },
  "mainSteps": [
    {
      "action": "aws:runShellScript",
      "name": "SystemUpdates",
      "inputs": {
        "timeoutSeconds": "1800",
        "runCommand": [
          "#!/bin/bash",
          "set -e",
          "exec > >(tee -a /var/log/ssm-system-updates.log)",
          "exec 2>&1",
          "",
          "echo '=== SYSTEM UPDATES PHASE ==='",
          "echo \"Start time: $(date)\"",
          "",
          "# DNF retry function",
          "retry_dnf() {",
          "    local max_attempts=3",
          "    local attempt=1",
          "    while [ $attempt -le $max_attempts ]; do",
          "        echo \"DNF attempt $attempt/$max_attempts: $*\"",
          "        if dnf clean all >/dev/null 2>&1 && dnf \"$@\"; then",
          "            echo \"✅ DNF operation succeeded\"",
          "            return 0",
          "        fi",
          "        if [ $attempt -lt $max_attempts ]; then",
          "            echo \"⚠️ DNF attempt $attempt failed, retrying in 30 seconds...\"",
          "            sleep 30",
          "        fi",
          "        ((attempt++))",
          "    done",
          "    echo \"❌ DNF operation failed after $max_attempts attempts\"",
          "    return 1",
          "}",
          "",
          "# Update system packages",
          "echo 'Updating system packages...'",
          "if retry_dnf update -y; then",
          "    echo '✅ System packages updated successfully'",
          "else",
          "    echo '❌ System package update failed'",
          "    exit 1",
          "fi",
          "",
          "# Verify AWS CLI is still working after updates",
          "if command -v aws >/dev/null 2>&1; then",
          "    echo '✅ AWS CLI verified working after updates'",
          "else",
          "    echo '⚠️ AWS CLI missing after updates, reinstalling...'",
          "    if retry_dnf install -y awscli || (retry_dnf install -y python3-pip && pip3 install awscli --break-system-packages); then",
          "        echo '✅ AWS CLI reinstalled'",
          "    else",
          "        echo '❌ AWS CLI reinstallation failed'",
          "        exit 1",
          "    fi",
          "fi",
          "",
          "# Create completion marker",
          "echo \"$(date): System updates completed successfully\" > /tmp/phase-system-updates-complete",
          "echo 'System updates phase completed successfully'",
          "echo \"Completion time: $(date)\""
        ]
      }
    }
  ]
}