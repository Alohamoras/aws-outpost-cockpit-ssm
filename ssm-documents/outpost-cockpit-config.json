{
  "schemaVersion": "2.2",
  "description": "AWS Outpost Cockpit final configuration (users, settings, verification)",
  "parameters": {
    "instanceId": {
      "type": "String",
      "description": "Instance ID for notifications",
      "default": "{{INSTANCE_ID}}"
    }
  },
  "mainSteps": [
    {
      "action": "aws:runShellScript",
      "name": "FinalConfiguration",
      "inputs": {
        "timeoutSeconds": "600",
        "runCommand": [
          "#!/bin/bash",
          "set -e",
          "exec > >(tee -a /var/log/ssm-cockpit-config.log)",
          "exec 2>&1",
          "",
          "echo '=== FINAL CONFIGURATION PHASE ==='",
          "echo \"Start time: $(date)\"",
          "",
          "# User configuration",
          "echo 'Configuring users...'",
          "if ! id admin >/dev/null 2>&1; then",
          "    useradd -m -G wheel admin",
          "    echo 'âœ… Admin user created'",
          "else",
          "    echo 'â„¹ï¸ Admin user already exists'",
          "fi",
          "",
          "# Set passwords",
          "echo 'admin:Cockpit123' | chpasswd",
          "echo 'rocky:Cockpit123' | chpasswd",
          "echo 'âœ… User passwords configured'",
          "",
          "# Configure sudo access",
          "echo '%wheel ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/wheel",
          "chmod 440 /etc/sudoers.d/wheel",
          "echo 'âœ… Sudo access configured'",
          "",
          "# Add users to relevant groups",
          "usermod -a -G wheel,libvirt,kvm admin 2>/dev/null || echo 'Group assignment warnings expected'",
          "usermod -a -G wheel,libvirt,kvm rocky 2>/dev/null || echo 'Group assignment warnings expected'",
          "echo 'âœ… User group assignments completed'",
          "",
          "# Final Cockpit service restart and verification",
          "echo 'Restarting Cockpit service...'",
          "systemctl restart cockpit.socket",
          "sleep 5",
          "",
          "# Get public IP for verification",
          "PUBLIC_IP=$(curl -s --max-time 10 http://169.254.169.254/latest/meta-data/public-ipv4 || echo 'IP-NOT-AVAILABLE')",
          "",
          "# Verify Cockpit is running",
          "if systemctl is-active --quiet cockpit.socket; then",
          "    echo 'âœ… Cockpit service is running'",
          "    ",
          "    # Optional: Test web interface connectivity",
          "    echo 'Testing Cockpit web interface...'",
          "    if curl -k -s --max-time 10 --connect-timeout 5 https://localhost:9090/ >/dev/null 2>&1; then",
          "        echo 'âœ… Cockpit web interface is accessible'",
          "    else",
          "        echo 'âš ï¸ Cockpit web interface test inconclusive (may be normal)'",
          "    fi",
          "    ",
          "    # Generate deployment summary",
          "    echo ''",
          "    echo '=============================================='",
          "    echo 'ðŸŽ‰ COCKPIT DEPLOYMENT COMPLETED SUCCESSFULLY!'",
          "    echo '=============================================='",
          "    echo \"Instance ID: {{instanceId}}\"",
          "    echo \"Public IP: $PUBLIC_IP\"",
          "    echo \"Cockpit URL: https://$PUBLIC_IP:9090\"",
          "    echo \"Users: admin/rocky (Password: Cockpit123)\"",
          "    ",
          "    # Check installed components",
          "    echo 'Installed Components:'",
          "    if systemctl is-active --quiet libvirtd 2>/dev/null; then",
          "        echo '  âœ… Virtualization (libvirt)'",
          "    else",
          "        echo '  âš ï¸ Virtualization (not available)'",
          "    fi",
          "    if command -v podman >/dev/null 2>&1; then",
          "        echo '  âœ… Containers (podman)'",
          "    else",
          "        echo '  âš ï¸ Containers (not available)'",
          "    fi",
          "    if systemctl is-active --quiet pmcd 2>/dev/null; then",
          "        echo '  âœ… Monitoring (PCP)'",
          "    else",
          "        echo '  âš ï¸ Monitoring (not available)'",
          "    fi",
          "    if rpm -q cockpit-file-sharing >/dev/null 2>&1; then",
          "        echo '  âœ… 45Drives Extensions'",
          "    else",
          "        echo '  âš ï¸ 45Drives Extensions (not available)'",
          "    fi",
          "    echo \"Completion Time: $(date)\"",
          "    echo '=============================================='",
          "else",
          "    echo 'âŒ Cockpit service failed final verification'",
          "    exit 1",
          "fi",
          "",
          "# Create final completion markers",
          "echo \"$(date): Complete Cockpit deployment finished successfully\" > /tmp/cockpit-deployment-complete",
          "echo \"$PUBLIC_IP\" > /tmp/instance-public-ip",
          "echo 'Final configuration phase completed successfully'",
          "echo \"Completion time: $(date)\""
        ]
      }
    }
  ]
}