{
  "schemaVersion": "2.2",
  "description": "AWS Outpost Cockpit third-party extensions (45Drives)",
  "parameters": {
    "snsTopicArn": {
      "type": "String",
      "description": "SNS Topic ARN for notifications"
    },
    "instanceId": {
      "type": "String",
      "description": "Instance ID for notifications",
      "default": "{{INSTANCE_ID}}"
    }
  },
  "mainSteps": [
    {
      "action": "aws:runShellScript",
      "name": "ThirdPartyExtensions",
      "inputs": {
        "timeoutSeconds": "1800",
        "runCommand": [
          "#!/bin/bash",
          "set -e",
          "exec > >(tee -a /var/log/ssm-cockpit-thirdparty.log)",
          "exec 2>&1",
          "",
          "echo '=== THIRD-PARTY EXTENSIONS INSTALLATION PHASE ==='",
          "echo \"Start time: $(date)\"",
          "",
          "# SNS notification function",
          "send_notification() {",
          "    local status=\"$1\"",
          "    local message=\"$2\"",
          "    if [[ -n '{{snsTopicArn}}' && '{{snsTopicArn}}' != 'None' ]]; then",
          "        aws sns publish --region $(curl -s http://169.254.169.254/latest/meta-data/placement/region) \\",
          "            --topic-arn '{{snsTopicArn}}' \\",
          "            --subject \"Third-party Extensions $status - {{instanceId}}\" \\",
          "            --message \"$message\" || echo 'SNS notification failed'",
          "    fi",
          "}",
          "",
          "# DNF retry function",
          "retry_dnf() {",
          "    local max_attempts=3",
          "    local attempt=1",
          "    while [ $attempt -le $max_attempts ]; do",
          "        echo \"DNF attempt $attempt/$max_attempts: $*\"",
          "        if dnf clean all >/dev/null 2>&1 && dnf \"$@\"; then",
          "            echo \"✅ DNF operation succeeded\"",
          "            return 0",
          "        fi",
          "        if [ $attempt -lt $max_attempts ]; then",
          "            echo \"⚠️ DNF attempt $attempt failed, retrying in 30 seconds...\"",
          "            sleep 30",
          "        fi",
          "        ((attempt++))",
          "    done",
          "    echo \"❌ DNF operation failed after $max_attempts attempts\"",
          "    return 1",
          "}",
          "",
          "send_notification 'STARTED' 'Third-party extensions installation started'",
          "",
          "# 45Drives extensions installation",
          "echo 'Installing 45Drives extensions...'",
          "DRIVES_SUCCESS=false",
          "",
          "# Clean up any existing repository files",
          "echo 'Cleaning up existing 45drives repository...'",
          "rm -f /etc/yum.repos.d/45drives.repo",
          "",
          "# Setup 45drives repository using official script",
          "echo 'Setting up 45drives repository...'",
          "if curl -sSL https://repo.45drives.com/setup | bash; then",
          "    echo '✅ 45drives repository setup successful'",
          "    ",
          "    # Clean and refresh cache",
          "    echo 'Refreshing package cache...'",
          "    dnf clean all >/dev/null 2>&1",
          "    dnf makecache >/dev/null 2>&1",
          "    ",
          "    # Install 45drives packages",
          "    if retry_dnf install -y cockpit-file-sharing cockpit-navigator cockpit-identities cockpit-sensors; then",
          "        echo '✅ 45drives extensions installed successfully'",
          "        DRIVES_SUCCESS=true",
          "    else",
          "        echo '⚠️ Some 45drives packages unavailable'",
          "    fi",
          "else",
          "    echo '⚠️ 45drives repository setup failed'",
          "fi",
          "",
          "# Create status summary",
          "echo ''",
          "echo '=== THIRD-PARTY EXTENSIONS SUMMARY ==='",
          "if [ '$DRIVES_SUCCESS' = true ]; then",
          "    echo '✅ 45Drives Extensions: Installed'",
          "    send_notification 'SUCCESS' '45Drives extensions installed successfully'",
          "else",
          "    echo '⚠️ 45Drives Extensions: Unavailable (non-critical)'",
          "    send_notification 'PARTIAL' '45Drives extensions unavailable but continuing with deployment'",
          "fi",
          "",
          "# Create completion marker",
          "echo \"$(date): Third-party extensions installation completed\" > /tmp/phase-cockpit-thirdparty-complete",
          "echo 'Third-party extensions installation phase completed'",
          "echo \"Completion time: $(date)\""
        ]
      }
    }
  ]
}